{% extends 'base_seller.html' %}
{% load humanize %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-800 mb-6">Inbox</h1>

        <div class="bg-white rounded-lg shadow-lg">
            <ul class="divide-y divide-gray-200">
                {% for convo in conversations %}
                    {# --- This is the corrected logic --- #}
                    {% if convo.sender == request.user %}
                        {% with other_user=convo.recipient %}
                            <a href="{% url 'listings:conversation-detail' other_user.id %}" class="block hover:bg-gray-50">
                                <li class="p-4 flex items-center justify-between">
                                    <div class="flex items-center">
                                        <img class="h-12 w-12 rounded-full object-cover mr-4" src="https://placehold.co/100x100/E2E8F0/4A5568?text={{ other_user.first_name.0|upper }}" alt="">
                                        <div>
                                            <p class="font-semibold text-gray-800">{{ other_user.first_name}} {{other_user.last_name }}</p>
                                            <p class="text-sm text-gray-600 truncate">You: {{ convo.body }}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-xs text-gray-400">{{ convo.timestamp|naturaltime }}</span>
                                    </div>
                                </li>
                            </a>
                        {% endwith %}
                    {% else %}
                        {% with other_user=convo.sender %}
                             <a href="{% url 'listings:conversation-detail' other_user.id %}" class="block hover:bg-gray-50">
                                <li class="p-4 flex items-center justify-between">
                                    <div class="flex items-center">
                                        <img class="h-12 w-12 rounded-full object-cover mr-4" src="https://placehold.co/100x100/E2E8F0/4A5568?text={{ other_user.username.0|upper }}" alt="">
                                        <div>
                                            <p class="font-semibold text-gray-800">{{ other_user.first_name}} {{other_user.last_name}}</p>
                                            <p class="text-sm text-gray-600 truncate">{{ convo.body }}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-xs text-gray-400">{{ convo.timestamp|naturaltime }}</span>
                                    </div>
                                </li>
                            </a>
                        {% endwith %}
                    {% endif %}
                {% empty %}
                <li class="p-8 text-center">
                    <p class="text-gray-500">You have no conversations.</p>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}
